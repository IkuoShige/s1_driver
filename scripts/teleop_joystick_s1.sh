#!/bin/bash

# RoboMaster S1 Joystick Teleoperation Script
# ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§ãƒ­ãƒœãƒƒãƒˆã‚’é éš”æ“ä½œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

echo "=== RoboMaster S1 Joystick Teleoperation ==="
echo ""

# ROS2ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
source /home/ikuo/s1_ws/install/setup.bash

# ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®æŽ¥ç¶šç¢ºèª
if [ ! -e /dev/input/js0 ]; then
    echo "âŒ ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãŒæŽ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "   USBã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’æŽ¥ç¶šã—ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
    exit 1
fi

echo "ðŸŽ® ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: /dev/input/js0"
echo ""

echo "ðŸ¤– S1ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
ros2 run s1_driver s1_driver_node &
DRIVER_PID=$!

# ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®åˆæœŸåŒ–ã‚’å¾…ã¤
echo "â³ ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­..."
sleep 4

echo ""
echo "âœ… S1ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "ðŸŽ® ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ†ãƒ¬ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸ“‹ ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯æ“ä½œæ–¹æ³•:"
echo "   å·¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯: å‰å¾Œç§»å‹•"
echo "   å³ã‚¹ãƒ†ã‚£ãƒƒã‚¯: å›žè»¢"
echo "   ãƒœã‚¿ãƒ³1 (é€šå¸¸Aãƒœã‚¿ãƒ³): ç·Šæ€¥åœæ­¢"
echo "   ãƒœã‚¿ãƒ³2 (é€šå¸¸Bãƒœã‚¿ãƒ³): é€Ÿåº¦ãƒªã‚»ãƒƒãƒˆ"
echo ""
echo "   Ctrl+C : çµ‚äº†"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# joy nodeã¨teleop_twist_joyã‚’åŒæ™‚ã«èµ·å‹•
echo "ðŸŽ¯ ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯åˆ¶å¾¡é–‹å§‹..."
trap 'echo ""; echo "ðŸ›‘ ãƒ†ãƒ¬ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†ä¸­..."; kill $DRIVER_PID $JOY_PID $TELEOP_PID 2>/dev/null; exit 0' INT

# joyãƒŽãƒ¼ãƒ‰ã‚’èµ·å‹•ï¼ˆãƒ‡ãƒã‚¤ã‚¹æŒ‡å®šï¼‰
ros2 run joy joy_node --ros-args -p device_id:=0 &
JOY_PID=$!

sleep 2

# teleop_twist_joyãƒŽãƒ¼ãƒ‰ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä»˜ãã§èµ·å‹•
ros2 run teleop_twist_joy teleop_node --ros-args \
  --params-file /home/ikuo/s1_ws/src/s1_driver/config/joystick_teleop.yaml \
  --remap cmd_vel:=/cmd_vel &
TELEOP_PID=$!

echo "ðŸŸ¢ ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯åˆ¶å¾¡ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"
echo "   ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§ãƒ­ãƒœãƒƒãƒˆã‚’æ“ä½œã—ã¦ãã ã•ã„"
echo ""

# ç„¡é™ãƒ«ãƒ¼ãƒ—ã§å¾…æ©Ÿ
while true; do
    sleep 1
done

# çµ‚äº†å‡¦ç†ï¼ˆCtrl+Cã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
echo ""
echo "ðŸ›‘ ã™ã¹ã¦ã®ãƒŽãƒ¼ãƒ‰ã‚’åœæ­¢ä¸­..."
kill $DRIVER_PID $JOY_PID $TELEOP_PID 2>/dev/null || true
wait $DRIVER_PID $JOY_PID $TELEOP_PID 2>/dev/null || true

echo "âœ… ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ†ãƒ¬ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†"
